<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAHAP - Vasúti Modul - Ügyfél Dashboard</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- VAHAP Közös Stílusok -->
    <link rel="stylesheet" href="../../assets/css/vihar-common.css">
</head>
<body>
    <div id="app">
        <!-- Fejléc -->
        <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #8B4513 0%, #654321 100%);">
            <div class="container">
                <span class="navbar-brand">
                    <i class="bi bi-train-front"></i> VAHAP - Vasúti Modul
                    <span class="badge bg-light text-dark ms-2">V-044</span>
                </span>
                <div class="ms-auto d-flex align-items-center gap-3">
                    <button class="btn btn-outline-light btn-sm" @click="showSugo = true">
                        <i class="bi bi-question-circle"></i> Súgó
                    </button>
                    <span class="text-white">
                        <i class="bi bi-person-circle"></i> {{ ugyfelNev }}
                    </span>
                    <a href="../../index.html" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-box-arrow-right"></i> Kilépés
                    </a>
                </div>
            </div>
        </nav>

        <!-- Tartalom -->
        <div class="container py-4">
            <!-- Oldal címsor -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4><i class="bi bi-kanban"></i> Ügyeim</h4>
                    <p class="text-muted mb-0">Vasúti járművezetői alkalmassági vizsgálat kérelmek</p>
                </div>
            </div>

            <!-- Gyors áttekintés - Akciók -->
            <div class="row mb-4">
                <!-- Új kérelem -->
                <div class="col-md-4">
                    <div class="card shadow-sm h-100 border-vasut">
                        <div class="card-body text-center">
                            <i class="bi bi-plus-circle-fill text-vasut" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">Új kérelem</h5>
                            <p class="text-muted">Indítson új alkalmassági vizsgálat kérelmet</p>
                            <a href="kerelem.html" class="btn btn-vasut">
                                <i class="bi bi-arrow-right-circle"></i> Kérelem indítása
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Intézkedés szükséges -->
                <div class="col-md-4">
                    <div class="card shadow-sm h-100 border-warning">
                        <div class="card-body text-center">
                            <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">Intézkedés szükséges</h5>
                            <p class="text-muted">{{ actionRequiredCount }} ügy vár intézkedésre</p>
                            <button class="btn btn-warning" @click="filterByActionRequired" :disabled="actionRequiredCount === 0">
                                <i class="bi bi-filter"></i> Megtekintés
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lezárt ügyek -->
                <div class="col-md-4">
                    <div class="card shadow-sm h-100 border-success">
                        <div class="card-body text-center">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">Lezárt ügyek</h5>
                            <p class="text-muted">{{ closedCasesCount }} ügy zárult le</p>
                            <button class="btn btn-success" @click="filterByClosed" :disabled="closedCasesCount === 0">
                                <i class="bi bi-archive"></i> Archívum
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Szűrők és keresés -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Státusz szűrő</label>
                            <select class="form-select" v-model="statusFilter">
                                <option value="">Összes ügy</option>
                                <option value="folyamatban">Folyamatban</option>
                                <option value="hiánypótlás">Hiánypótlás</option>
                                <option value="tényállás tisztázás">Tényállás tisztázás</option>
                                <option value="jóváhagyva">Jóváhagyva</option>
                                <option value="elutasítva">Elutasítva</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Keresés ügyazonosítóra</label>
                            <input type="text" class="form-control" v-model="searchQuery" placeholder="pl. VAHAP-V-2024-001234">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Rendezés</label>
                            <select class="form-select" v-model="sortBy">
                                <option value="date-desc">Legújabb elől</option>
                                <option value="date-asc">Legrégebbi elől</option>
                                <option value="deadline">Határidő szerint</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Munkalista - Egyedi kártyák -->
            <div class="row">
                <div class="col-12" v-if="filteredCases.length === 0">
                    <div class="alert alert-info text-center">
                        <i class="bi bi-inbox"></i> Nincs megjeleníthető ügy a kiválasztott szűrővel
                    </div>
                </div>

                <div class="col-md-6 mb-4" v-for="ugy in filteredCases" :key="ugy.ugyazonosito">
                    <div class="card shadow-sm h-100" :class="{'border-warning': ugy.ugyfelMuvelet, 'border-success': ugy.statusz === 'jóváhagyva', 'border-danger': ugy.statusz === 'elutasítva'}">
                        <!-- Kártya fejléc -->
                        <div class="card-header d-flex justify-content-between align-items-center" :class="getHeaderClass(ugy)">
                            <div>
                                <h6 class="mb-0">
                                    <i class="bi" :class="getStatusIcon(ugy.statusz)"></i>
                                    {{ ugy.ugyazonosito }}
                                </h6>
                                <small>{{ ugy.megnevezes }}</small>
                            </div>
                            <span class="badge" :class="'badge-' + ugy.statuszClass">
                                {{ ugy.statusz }}
                            </span>
                        </div>

                        <!-- Kártya tartalom -->
                        <div class="card-body">
                            <!-- Alapadatok -->
                            <div class="mb-3">
                                <div class="row text-muted small">
                                    <div class="col-6">
                                        <i class="bi bi-calendar"></i> Benyújtva:<br>
                                        <strong class="text-dark">{{ ugy.benyujtasDatum }}</strong>
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-clock"></i> Határidő:<br>
                                        <strong class="text-dark" :class="{'text-danger': isDeadlineClose(ugy.hatarido)}">
                                            {{ ugy.hatarido }}
                                            <i v-if="isDeadlineClose(ugy.hatarido)" class="bi bi-exclamation-circle text-danger"></i>
                                        </strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Intézkedés szükséges jelzés -->
                            <div v-if="ugy.ugyfelMuvelet" class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Intézkedés szükséges!</strong><br>
                                <small v-if="ugy.ugyfelMuvelet === 'hianypotlas'">
                                    Hiánypótlási határidő: <strong>{{ ugy.hianypotlasHatarido }}</strong>
                                </small>
                                <small v-if="ugy.ugyfelMuvelet === 'tenyallas_tisztazas'">
                                    Tényállás tisztázás határidő: <strong>{{ ugy.tenyallasHatarido }}</strong>
                                </small>
                            </div>

                            <!-- Dokumentumok száma -->
                            <div class="mb-3">
                                <i class="bi bi-file-text"></i>
                                <small class="text-muted">
                                    {{ ugy.dokumentumok ? ugy.dokumentumok.length : 0 }} dokumentum elérhető
                                </small>
                            </div>

                            <!-- Akciógombok -->
                            <div class="d-grid gap-2">
                                <!-- Hiánypótlás -->
                                <button v-if="ugy.ugyfelMuvelet === 'hianypotlas'" class="btn btn-warning" @click="openCase(ugy)">
                                    <i class="bi bi-pencil-square"></i> Hiánypótlás benyújtása
                                    <span class="badge bg-dark ms-1">F-0101</span>
                                </button>

                                <!-- Tényállás tisztázás -->
                                <button v-if="ugy.ugyfelMuvelet === 'tenyallas_tisztazas'" class="btn btn-info text-white" @click="openCase(ugy)">
                                    <i class="bi bi-chat-left-text"></i> Tényállás tisztázás
                                    <span class="badge bg-dark ms-1">F-0104</span>
                                </button>

                                <!-- Ügy részletek -->
                                <button v-if="!ugy.ugyfelMuvelet" class="btn btn-outline-vasut" @click="openCase(ugy)">
                                    <i class="bi bi-eye"></i> Ügy részletei
                                    <span class="badge bg-secondary ms-1">F-0107</span>
                                </button>

                                <!-- Dokumentumok letöltése -->
                                <button v-if="ugy.dokumentumok && ugy.dokumentumok.length > 0" class="btn btn-outline-secondary btn-sm" @click="openCase(ugy)">
                                    <i class="bi bi-download"></i> Dokumentumok ({{ ugy.dokumentumok.length }})
                                </button>
                            </div>
                        </div>

                        <!-- Kártya lábléc - gyors info -->
                        <div class="card-footer bg-light text-muted small">
                            <i class="bi bi-info-circle"></i>
                            <span v-if="ugy.statusz === 'folyamatban'">Hatósági feldolgozás alatt</span>
                            <span v-if="ugy.statusz === 'hiánypótlás'">{{ daysUntilDeadline(ugy.hianypotlasHatarido) }} nap van a hiánypótlásra</span>
                            <span v-if="ugy.statusz === 'tényállás tisztázás'">{{ daysUntilDeadline(ugy.tenyallasHatarido) }} nap van a válaszadásra</span>
                            <span v-if="ugy.statusz === 'jóváhagyva'">Döntés dátuma: {{ ugy.dontesDatum }}</span>
                            <span v-if="ugy.statusz === 'elutasítva'">Elutasítva: {{ ugy.dontesDatum }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Súgó Modal -->
        <vahap-sugo-modal-ugyfel
            :show="showSugo"
            @close="showSugo = false">
        </vahap-sugo-modal-ugyfel>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- VAHAP Központi Fájlok -->
    <script src="../../assets/js/vihar-config.js"></script>
    <script src="../../assets/js/vihar-common.js"></script>
    <script src="../../assets/js/vihar-mock-data.js"></script>
    <script src="../../assets/js/vihar-components.js"></script>
    <script src="../../assets/js/components/vihar-sugo-modal-ugyfel.js"></script>

    <!-- Oldal-specifikus Vue App -->
    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    ugyfelNev: "Kovács János",
                    showSugo: false,
                    cases: [],

                    // Szűrők
                    statusFilter: '',
                    searchQuery: '',
                    sortBy: 'date-desc'
                };
            },
            computed: {
                // Intézkedés szükséges ügyek száma
                actionRequiredCount() {
                    return this.cases.filter(u => u.ugyfelMuvelet).length;
                },

                // Lezárt ügyek száma
                closedCasesCount() {
                    return this.cases.filter(u => u.statusz === 'jóváhagyva' || u.statusz === 'elutasítva').length;
                },

                // Szűrt és rendezett ügyek
                filteredCases() {
                    let result = [...this.cases];

                    // Státusz szűrő
                    if (this.statusFilter) {
                        result = result.filter(u => u.statusz === this.statusFilter);
                    }

                    // Keresés
                    if (this.searchQuery) {
                        result = result.filter(u =>
                            u.ugyazonosito.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }

                    // Rendezés
                    if (this.sortBy === 'date-desc') {
                        result.sort((a, b) => new Date(b.benyujtasDatum) - new Date(a.benyujtasDatum));
                    } else if (this.sortBy === 'date-asc') {
                        result.sort((a, b) => new Date(a.benyujtasDatum) - new Date(b.benyujtasDatum));
                    } else if (this.sortBy === 'deadline') {
                        result.sort((a, b) => new Date(a.hatarido) - new Date(b.hatarido));
                    }

                    return result;
                }
            },
            methods: {
                // Ügyek betöltése
                loadCases() {
                    // Mock adatok
                    this.cases = [...VahapMockData.vasut.ugyek_kulso];

                    // LocalStorage-ból betöltés
                    const localCases = JSON.parse(localStorage.getItem('vahap_ugyek_kulso_vasut') || '[]');

                    // Összefűzés (LocalStorage felülírja a mock-ot azonos ID esetén)
                    localCases.forEach(localCase => {
                        const index = this.cases.findIndex(c => c.ugyazonosito === localCase.ugyazonosito);
                        if (index !== -1) {
                            this.cases[index] = localCase;
                        } else {
                            this.cases.push(localCase);
                        }
                    });

                    console.log('Ügyek betöltve:', this.cases.length);
                },

                // Szűrés: intézkedés szükséges
                filterByActionRequired() {
                    this.statusFilter = '';
                    this.searchQuery = '';
                    // Speciális szűrés - csak ahol van ugyfelMuvelet
                    this.cases = this.cases.filter(u => u.ugyfelMuvelet);
                },

                // Szűrés: lezárt ügyek
                filterByClosed() {
                    this.statusFilter = '';
                    this.searchQuery = '';
                    this.cases = this.cases.filter(u => u.statusz === 'jóváhagyva' || u.statusz === 'elutasítva');
                },

                // Ügy megnyitása
                openCase(caseItem) {
                    console.log('[VAHAP] Ügy megnyitása:', caseItem.ugyazonosito);
                    VahapCommon.storage.save('selected_case', caseItem);

                    // Ügyfél művelet alapján átirányítás
                    if (caseItem.ugyfelMuvelet === 'hianypotlas') {
                        window.location.href = `hianypotlas.html?ugy=${caseItem.ugyazonosito}`;
                    } else if (caseItem.ugyfelMuvelet === 'tenyallas_tisztazas') {
                        window.location.href = `tenyallas-tisztazas.html?ugy=${caseItem.ugyazonosito}`;
                    } else {
                        window.location.href = `ugy-reszletek.html?ugy=${caseItem.ugyazonosito}`;
                    }
                },

                // Státusz ikon
                getStatusIcon(statusz) {
                    const icons = {
                        'folyamatban': 'bi-hourglass-split',
                        'hiánypótlás': 'bi-exclamation-triangle',
                        'tényállás tisztázás': 'bi-chat-left-text',
                        'jóváhagyva': 'bi-check-circle-fill',
                        'elutasítva': 'bi-x-circle-fill'
                    };
                    return icons[statusz] || 'bi-folder';
                },

                // Fejléc osztály
                getHeaderClass(ugy) {
                    if (ugy.ugyfelMuvelet) return 'bg-warning text-dark';
                    if (ugy.statusz === 'jóváhagyva') return 'bg-success text-white';
                    if (ugy.statusz === 'elutasítva') return 'bg-danger text-white';
                    return 'bg-light';
                },

                // Határidő közel van?
                isDeadlineClose(deadline) {
                    const today = new Date();
                    const deadlineDate = new Date(deadline);
                    const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                    return diffDays <= 7 && diffDays >= 0;
                },

                // Napok határidőig
                daysUntilDeadline(deadline) {
                    const today = new Date();
                    const deadlineDate = new Date(deadline);
                    const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                    return diffDays > 0 ? diffDays : 0;
                }
            },
            mounted() {
                console.log('[VAHAP] Vasúti Külső Munkalista betöltve');
                this.loadCases();
            }
        });

        // Komponens regisztráció
        app.component('vahap-sugo-modal-ugyfel', VahapSugoModalUgyfel);

        app.mount('#app');
    </script>
</body>
</html>
