<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Véleményezésre előterjesztés - VAHAP Vasúti Modul</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- VAHAP Közös CSS -->
    <link href="../../assets/css/vihar-common.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .page-header {
            background: linear-gradient(135deg, var(--vahap-primary) 0%, #5a32a3 100%);
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .workflow-step {
            flex: 1;
            text-align: center;
            padding: 1rem;
            position: relative;
        }

        .workflow-step::after {
            content: '';
            position: absolute;
            top: 2rem;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }

        .workflow-step:last-child::after {
            display: none;
        }

        .workflow-step.active .step-circle {
            background: var(--vahap-primary);
            color: white;
        }

        .workflow-step.completed .step-circle {
            background: var(--vahap-positive);
            color: white;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .dokumentum-preview {
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .velemenyezo-card {
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .velemenyezo-card:hover {
            border-color: var(--vahap-primary);
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.2);
        }

        .velemenyezo-card.selected {
            border-color: var(--vahap-primary);
            background-color: #f8f4ff;
        }

        .velemenyezo-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin: 0.25rem;
        }
    </style>

    <!-- DÁP Design System - Inter betűtípus -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Fejléc -->
        <div class="page-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-0">
                            <i class="bi bi-send"></i> Véleményezésre előterjesztés
                        </h3>
                        <p class="mb-0 mt-2">
                            <i class="bi bi-person-badge"></i> {{ currentUser.nev }} | Ügyintéző
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light" @click="goBack">
                            <i class="bi bi-arrow-left"></i> Vissza
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow lépések -->
        <div class="container-fluid mb-4">
            <div class="workflow-steps">
                <div class="workflow-step" :class="{ active: currentStep === 1, completed: currentStep > 1 }">
                    <div class="step-circle">
                        <i v-if="currentStep > 1" class="bi bi-check"></i>
                        <span v-else>1</span>
                    </div>
                    <div class="fw-bold">Dokumentum kiválasztás</div>
                </div>
                <div class="workflow-step" :class="{ active: currentStep === 2, completed: currentStep > 2 }">
                    <div class="step-circle">
                        <i v-if="currentStep > 2" class="bi bi-check"></i>
                        <span v-else>2</span>
                    </div>
                    <div class="fw-bold">Véleményezők kiválasztása</div>
                </div>
                <div class="workflow-step" :class="{ active: currentStep === 3, completed: currentStep > 3 }">
                    <div class="step-circle">
                        <i v-if="currentStep > 3" class="bi bi-check"></i>
                        <span v-else>3</span>
                    </div>
                    <div class="fw-bold">Üzenet és elküldés</div>
                </div>
            </div>
        </div>

        <!-- Főtartalom -->
        <div class="container-fluid">
            <!-- 1. lépés: Dokumentum kiválasztás -->
            <div v-if="currentStep === 1" class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i> 1. lépés: Válasszon dokumentumot
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Dokumentumok listája -->
                        <div class="col-md-6">
                            <h6 class="mb-3">Elérhető dokumentum tervezetek:</h6>
                            <div class="list-group">
                                <a v-for="dok in sajatDokumentumok"
                                   :key="dok.id"
                                   href="#"
                                   class="list-group-item list-group-item-action"
                                   :class="{ active: selectedDokumentum?.id === dok.id }"
                                   @click.prevent="selectDokumentum(dok)">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-bold">{{ dok.tipus_cim }}</div>
                                            <div class="small text-muted">{{ dok.ugyazonosito }}</div>
                                            <div class="small">
                                                <i class="bi bi-calendar"></i> {{ formatDate(dok.letrehozva) }}
                                            </div>
                                        </div>
                                        <span class="badge bg-info">{{ dok.tipus }}</span>
                                    </div>
                                </a>

                                <div v-if="sajatDokumentumok.length === 0" class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Nincs elérhető dokumentum tervezet
                                </div>
                            </div>
                        </div>

                        <!-- Kiválasztott dokumentum előnézet -->
                        <div class="col-md-6">
                            <div v-if="selectedDokumentum">
                                <h6 class="mb-3">Dokumentum előnézet:</h6>
                                <div class="dokumentum-preview">
                                    <h5>{{ selectedDokumentum.tipus_cim }}</h5>
                                    <p class="text-muted">{{ selectedDokumentum.ugyazonosito }}</p>
                                    <hr>
                                    <pre style="white-space: pre-wrap; font-size: 0.9rem;">{{ selectedDokumentum.tartalom }}</pre>
                                </div>
                                <div class="mt-3 d-grid">
                                    <button class="btn btn-primary btn-lg" @click="nextStep">
                                        Tovább a véleményezők kiválasztásához
                                        <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-else class="alert alert-secondary">
                                <i class="bi bi-arrow-left"></i> Válasszon dokumentumot a bal oldali listából
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. lépés: Véleményezők kiválasztása -->
            <div v-if="currentStep === 2" class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people"></i> 2. lépés: Válassza ki a véleményezőket
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Véleményezés komponens -->
                    <vihar-velemenyezes
                        :dokumentum="selectedDokumentum"
                        mode="eloterjesztes"
                        :current-user="currentUser"
                        @velemenyezes-elkuldve="handleVelemenyezesElkuldve">
                    </vihar-velemenyezes>

                    <!-- Navigációs gombok -->
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-secondary" @click="prevStep">
                            <i class="bi bi-arrow-left"></i> Vissza
                        </button>
                        <button class="btn btn-primary" @click="nextStep" :disabled="selectedVelemenyezok.length === 0">
                            Tovább az üzenet megadásához
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3. lépés: Kísérő üzenet és elküldés -->
            <div v-if="currentStep === 3" class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-send"></i> 3. lépés: Véleményezésre küldés
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Összefoglaló -->
                        <div class="col-md-6">
                            <h6>Összefoglaló:</h6>

                            <div class="alert alert-info mb-3">
                                <strong><i class="bi bi-file-text"></i> Dokumentum:</strong>
                                <p class="mb-0">{{ selectedDokumentum.tipus_cim }}</p>
                                <small class="text-muted">{{ selectedDokumentum.ugyazonosito }}</small>
                            </div>

                            <div class="alert alert-success mb-3">
                                <strong><i class="bi bi-people"></i> Kiválasztott véleményezők ({{ selectedVelemenyezok.length }}):</strong>
                                <div class="mt-2">
                                    <div v-for="v in selectedVelemenyezok" :key="v.id" class="velemenyezo-badge bg-light border">
                                        <i class="bi bi-person-check"></i> {{ v.nev }}
                                        <span class="badge bg-secondary ms-1">{{ v.szerepkor }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <strong><i class="bi bi-alarm"></i> Határidő:</strong>
                                <p class="mb-0">{{ formatDate(velemenyezesHatarido) }}</p>
                                <small class="text-muted">3 munkanap múlva</small>
                            </div>
                        </div>

                        <!-- Kísérő üzenet -->
                        <div class="col-md-6">
                            <h6>Kísérő üzenet (opcionális):</h6>
                            <textarea v-model="kiseroUzenet"
                                      class="form-control mb-3"
                                      rows="10"
                                      placeholder="Írjon üzenetet a véleményezőknek (pl. mire figyeljenek oda, miért fontos, sürgősségi információk...)"></textarea>

                            <div class="form-check mb-3">
                                <input type="checkbox"
                                       v-model="emailErtesites"
                                       class="form-check-input"
                                       id="emailCheck">
                                <label class="form-check-label" for="emailCheck">
                                    <i class="bi bi-envelope"></i> Email értesítés küldése minden véleményezőnek
                                </label>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-success btn-lg" @click="kuldesVelemenyezesre">
                                    <i class="bi bi-send-fill"></i> Véleményezésre küldés mindenkinek
                                </button>
                                <button class="btn btn-secondary" @click="prevStep">
                                    <i class="bi bi-arrow-left"></i> Vissza
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sikeres küldés -->
            <div v-if="currentStep === 4" class="card shadow-sm border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle"></i> Sikeres véleményezésre küldés
                    </h5>
                </div>
                <div class="card-body text-center py-5">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                    <h4 class="mt-4">Véleményezésre sikeresen elküldve!</h4>
                    <p class="text-muted mb-4">
                        A dokumentum elküldve {{ selectedVelemenyezok.length }} véleményezőnek.<br>
                        {{ emailErtesites ? 'Email értesítések kiküldve.' : 'Értesítések kikapcsolva voltak.' }}
                    </p>

                    <div class="alert alert-info d-inline-block">
                        <strong><i class="bi bi-info-circle"></i> Mi történik most?</strong>
                        <ul class="text-start mt-2 mb-0">
                            <li>A véleményezők megkapták a dokumentumot</li>
                            <li>Értesítést kapnak az új feladatról</li>
                            <li>{{ formatDate(velemenyezesHatarido) }} határidőig véleményezhetnek</li>
                            <li>A vélemények a "Vélemények értékelése" oldalon fognak megjelenni</li>
                        </ul>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-primary me-2" @click="goToVelemenyErtekeles">
                            <i class="bi bi-eye"></i> Vélemények nyomon követése
                        </button>
                        <button class="btn btn-outline-secondary" @click="resetForm">
                            <i class="bi bi-arrow-clockwise"></i> Új véleményezés indítása
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- VAHAP Központi Fájlok -->
    <script src="../../assets/js/vihar-config.js"></script>
    <script src="../../assets/js/vihar-common.js"></script>
    <script src="../../assets/js/vihar-mock-data.js"></script>

    <!-- VAHAP Komponensek -->
    <script src="../../assets/js/components/vihar-velemenyezes.js"></script>

    <!-- Oldal specifikus Vue App -->
    <script>
        const { createApp } = Vue;

        createApp({
            components: {
                'vihar-velemenyezes': ViharVelemenyezes
            },

            data() {
                return {
                    currentUser: {
                        nev: 'Dr. Szabó Péter',
                        beosztas: 'Vezető ügyintéző',
                        szerepkor: 'ugyintezo'
                    },

                    currentStep: 1,

                    selectedDokumentum: null,
                    selectedVelemenyezok: [],
                    kiseroUzenet: '',
                    emailErtesites: true,

                    sajatDokumentumok: []
                };
            },

            computed: {
                velemenyezesHatarido() {
                    // 3 munkanap múlva
                    const date = new Date();
                    date.setDate(date.getDate() + 3);
                    return date.toISOString();
                }
            },

            methods: {
                loadDokumentumok() {
                    // Mock dokumentumok betöltése (ügyintéző saját tervezetei)
                    this.sajatDokumentumok = [
                        {
                            id: 1,
                            ugyazonosito: 'VAHAP-V-2024-001234',
                            tipus: 'határozat',
                            tipus_cim: 'Határozat tervezet - Alkalmassági vizsgálat engedélyezése',
                            letrehozva: '2024-10-25T10:00:00',
                            tartalom: `HATÁROZAT

Ügyazonosító: VAHAP-V-2024-001234

RENDELKEZŐ RÉSZ:

A benyújtott kérelem alapján engedélyezem Minta János (szül.: 1985.03.15.) részére a vasúti járművezető előzetes alkalmassági vizsgálatát.

Az engedély hatálya: 2024.11.01 - 2029.10.31 (5 év)

INDOKOLÁS:

A kérelmező megfelelt a 123/2023. (XII. 15.) Korm. rendelet szerinti előírásoknak. Az orvosi és pszichológiai vizsgálatok eredményei megfelelnek az előírásoknak.

JOGORVOSLAT:

Ezen határozat ellen 15 napon belül fellebbezés nyújtható be az Építési és Közlekedési Minisztérium címére.`
                        },
                        {
                            id: 2,
                            ugyazonosito: 'VAHAP-V-2024-001237',
                            tipus: 'vegzes',
                            tipus_cim: 'Végzés tervezet - Eljárás felfüggesztése',
                            letrehozva: '2024-10-24T15:30:00',
                            tartalom: `VÉGZÉS

Ügyazonosító: VAHAP-V-2024-001237

RENDELKEZÉS:

Az eljárást FELFÜGGESZTEM a szakhatósági állásfoglalás beszerzéséig.

INDOKOLÁS:

Az ügy elbírálásához a Közlekedési Alkalmassági és Vizsgaközpont szakértői véleménye szükséges.`
                        }
                    ];
                },

                selectDokumentum(dok) {
                    this.selectedDokumentum = dok;
                },

                nextStep() {
                    if (this.currentStep < 4) {
                        this.currentStep++;
                    }
                },

                prevStep() {
                    if (this.currentStep > 1) {
                        this.currentStep--;
                    }
                },

                handleVelemenyezesElkuldve(data) {
                    console.log('[Előterjesztés] Véleményezők kiválasztva:', data);
                    this.selectedVelemenyezok = data.selected || [];
                },

                kuldesVelemenyezesre() {
                    if (!this.selectedDokumentum || this.selectedVelemenyezok.length === 0) {
                        alert('⚠️ Kérem válasszon dokumentumot és véleményezőket!');
                        return;
                    }

                    const payload = {
                        dokumentum: this.selectedDokumentum,
                        velemenyezok: this.selectedVelemenyezok,
                        kisero_uzenet: this.kiseroUzenet,
                        email_ertesites: this.emailErtesites,
                        hatarido: this.velemenyezesHatarido,
                        kuldo: this.currentUser,
                        kuldve: new Date().toISOString()
                    };

                    console.log('[VAHAP] Véleményezésre küldés:', payload);

                    // Mock: Sikeres küldés
                    if (this.emailErtesites) {
                        this.selectedVelemenyezok.forEach(v => {
                            console.log(`[VAHAP] Email értesítés küldve: ${v.email || v.nev}`);
                        });
                    }

                    // Következő lépés (sikeres)
                    this.nextStep();
                },

                resetForm() {
                    this.currentStep = 1;
                    this.selectedDokumentum = null;
                    this.selectedVelemenyezok = [];
                    this.kiseroUzenet = '';
                    this.emailErtesites = true;
                },

                goToVelemenyErtekeles() {
                    window.location.href = 'velemeny-ertekeles.html';
                },

                formatDate(dateStr) {
                    if (!dateStr) return 'N/A';
                    const date = new Date(dateStr);
                    return date.toLocaleString('hu-HU', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                goBack() {
                    window.history.back();
                }
            },

            mounted() {
                console.log('[VAHAP] Véleményezés előterjesztés oldal betöltve');
                this.loadDokumentumok();
            }
        }).mount('#app');
    </script>
</body>
</html>
